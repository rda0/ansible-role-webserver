{% for port_name, port_config in vhost.ports.items() %}
<VirtualHost *:{{ webserver_vhost_ports[port_name].number }}>
  ServerName {{ vhost.server_name }}
{% if not port_config.empty %}
  DocumentRoot {{ vhost.document_root }}
{% else %}
  DocumentRoot {{ webserver_empty_doc_root }}
{% endif %}
{% if vhost.server_alias != '' %}
  ServerAlias {{ vhost.server_alias }}
{% endif %}
{% if port_config.cert is not none %}
{% if port_config.cert == '' %}
  Use EnableSSL
{% else %}
  Use EnableSSLCert {{ port_config.cert }}
{% endif %}
{% endif %}
{% if port_config.redirect != '' %}
  Use RedirectTo{% if port_config.redirect.count(' ') == 2 %}Subdir{% endif %} {{ port_config.redirect }}
{% endif %}
  LogLevel {{ webserver_log_level }}
{% if vhost.type == 'share' %}
  ErrorLog {{ vhost.home_path }}/{{ vhost.name }}/logs/{{ port_name }}_error.log
  CustomLog {{ vhost.home_path }}/{{ vhost.name }}/logs/{{ port_name }}_access.log combined env=!dontlog
{% elif vhost.type == 'redirect' %}
  ErrorLog ${APACHE_LOG_DIR}/sites/redirect_{{ port_name }}_error.log
  CustomLog ${APACHE_LOG_DIR}/sites/redirect_{{ port_name }}_access.log vhost_combined env=!dontlog
{% else %}
  ErrorLog ${APACHE_LOG_DIR}/sites/{{ vhost.name }}_{{ port_name }}_error.log
  CustomLog ${APACHE_LOG_DIR}/sites/{{ vhost.name }}_{{ port_name }}_access.log combined env=!dontlog
{% endif %}
{% if webserver_log_lastuse %}
  CustomLog ${APACHE_LOG_DIR}/lastuse.fifo lastuse env=!dontloglastuse
{% endif %}
{% if not port_config.empty %}
{% if port_name == 'https' and vhost.type == 'share' %}
  Alias /website-statistics {{ vhost.home_path }}/{{ vhost.name }}/stats
  <Directory {{ vhost.home_path }}/{{ vhost.name }}/stats>
    Use PhysLDAP
    Use RequirePhysLDAPGroup isg
    Use RequirePhysLDAPGroup {{ vhost.name }}
    Options Multiviews Indexes
  </Directory>
{% endif %}
{% if port_config.require != '' %}
{% if port_config.require == 'wsgi' %}
  <Directory "{{ vhost.document_root }}{{ vhost.wsgi.app|dirname|length|ternary('/','') }}{{ vhost.wsgi.app|dirname }}">
    <Files "{{ vhost.wsgi.app|basename }}">
      Require all granted
    </Files>
  </Directory>
{% for dir in vhost.wsgi.static %}
  Alias "/{{ dir|basename }}" "{{ vhost.document_root }}/{{ dir }}"
  <Directory "{{ vhost.document_root }}/{{ dir }}">
    Require all granted
  </Directory>
{% endfor %}
{% else %}
  <Directory {{ vhost.document_root }}>
    {{ (webserver_site_config_common_requires[port_config.require]|indent(width=4)).rstrip() }}
  </Directory>
{% endif %}
{% endif %}
{% else %}
{% if port_config.require != '' %}
{% if vhost.type == 'server' %}
  <Location />
    {{ (webserver_site_config_common_requires[port_config.require]|indent(width=4)).rstrip() }}
  </Location>
{% else %}
  <Location />
    Require all granted
  </Location>
{% endif %}
{% endif %}
{% endif %}
{% if not port_config.empty %}
{% if vhost.name in phpfpm_pool_names %}
  DirectoryIndex index.php index.html
  # Enable http authorization headers
  <IfModule setenvif_module>
    SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
  </IfModule>
  # Use php-fpm socket
  <FilesMatch "\.(?i:php[3457]?)$">
    SetHandler "proxy:unix:/run/php/php{{ _webserver_php_version }}-fpm-{{ vhost.name }}.sock|fcgi://localhost"
  </FilesMatch>
{% endif %}
{% if port_name in vhost.fcgid.ports and vhost.fcgid.extensions %}
  DirectoryIndex{% for ext in vhost.fcgid.extensions %} index.{{ ext }}{% endfor %} index.html
  <IfModule suexec_module>
    SuexecUserGroup {{ vhost.name }} {{ vhost.name }}
  </IfModule>
  # Enable http authorization headers
  <IfModule setenvif_module>
    SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
  </IfModule>
  <Directory {{ vhost.document_root }}>
    Options +ExecCGI
{% for ext in vhost.fcgid.extensions %}
    AddHandler fcgid-script .{{ ext }}
{% endfor %}
{% for ext in vhost.fcgid.extensions if ext not in webserver_fcgid_fcgi_extensions %}
    FcgidWrapper {{ vhost.home_path }}/{{ vhost.name }}/fcgid/fcgid-wrapper-{{ ext if ext in webserver_fcgid_custom_wrappers else 'generic' }} .{{ ext }}
{% endfor %}
  </Directory>
{% endif %}
{% if port_name in vhost.wsgi.ports and vhost.wsgi.app != '' %}
{% if vhost.wsgi.ports | first == port_name %}
{% if vhost.wsgi.venv %}
  WSGIDaemonProcess {{ vhost.name }} user={{ vhost.name }} group={{ vhost.name }} processes={{ vhost.wsgi.processes }} threads={{ vhost.wsgi.threads }} display-name=%{GROUP} home={{ vhost.document_root }} lang={{ vhost.wsgi.locale }} locale={{ vhost.wsgi.locale }} python-home={{ vhost.document_root }}/{{ vhost.wsgi.venv_path }}
{% else %}
  WSGIDaemonProcess {{ vhost.name }} user={{ vhost.name }} group={{ vhost.name }} processes={{ vhost.wsgi.processes }} threads={{ vhost.wsgi.threads }} display-name=%{GROUP} home={{ vhost.document_root }} lang={{ vhost.wsgi.locale }} locale={{ vhost.wsgi.locale }}
{% endif %}
{% endif %}
  WSGIProcessGroup {{ vhost.name }}
{% if vhost.wsgi.application_group != '' %}
  WSGIApplicationGroup {{ vhost.wsgi.application_group }}
{% endif %}
  WSGIScriptAlias {{ vhost.wsgi.script_alias }} {{ vhost.document_root }}/{{ vhost.wsgi.app }}
{% endif %}
{% if vhost.website.type == 'wordpress' %}
  <Directory {{ vhost.document_root }}>
    {{ (webserver_site_config_common_wordpress['rewrite']|indent(width=4)).rstrip() }}
  </Directory>
  <Directory {{ vhost.document_root }}/wp-content/plugins/akismet>
    {{ (webserver_site_config_common_wordpress['akismet']|indent(width=4)).rstrip() }}
  </Directory>
{% endif %}
{% endif %}
{% if port_config.config %}
  {{ (port_config.config|indent(width=2)).rstrip() }}
{% endif %}
{% for include in port_config.includes %}
  IncludeOptional /etc/apache2/sites-include/{{ include }}.conf
{% endfor %}
</VirtualHost>

{% endfor %}
# vim: syntax=apache
